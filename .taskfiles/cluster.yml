---
version: "3"

vars:
  K3S_PRIMARY_MASTER_NODE_USERNAME: "twitlin"
  K3S_PRIMARY_MASTER_NODE_ADDR: "10.10.10.26"
  K3S_LB_ADDR: "10.10.10.2"

tasks:
  kubeconfig:
    desc: Remotely fetch kubeconfig from k3s
    cmds:
      - rsync --verbose --progress --partial --rsync-path="sudo rsync" {{.K3S_PRIMARY_MASTER_NODE_USERNAME}}@{{.K3S_PRIMARY_MASTER_NODE_ADDR}}:/etc/rancher/k3s/k3s.yaml {{.CLUSTER_DIR.}}/kubeconfig
      - sed -i '' 's/127.0.0.1/{{.K3S_LB_ADDR}}/g' {{.CLUSTER_DIR}}/kubeconfig
      - chmod go-r {{.CLUSTER_DIR}}/kubeconfig
